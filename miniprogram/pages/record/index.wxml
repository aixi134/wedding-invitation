<view class="container">
  <!-- éç®¡ç†å‘˜æç¤º -->
  <view wx:if="{{!isManager}}" class="no-permission">
    <view class="permission-tip">æ‚¨æš‚æ— æƒé™æŸ¥çœ‹è®¿å®¢è®°å½•</view>
    <view class="permission-desc">è¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜</view>
  </view>

  <!-- ç®¡ç†å‘˜ç•Œé¢ -->
  <view wx:else class="manager-view">
    <!-- æœç´¢æ  -->
    <view class="search-bar">
      <view class="search-input">
        <input 
          value="{{keyword}}" 
          placeholder="è¾“å…¥è®¿å®¢å§“åæˆ–è®¿é—®ç›®çš„" 
          bindinput="onSearchInput"
          bindconfirm="onSearch"
        />
        <text class="search-icon" bindtap="onSearch">ğŸ”</text>
        <text wx:if="{{keyword}}" class="clear-icon" bindtap="onClearSearch">Ã—</text>
      </view>
    </view>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <view class="stats">
      <text class="welcome-text">æ¬¢è¿ï¼Œ{{userInfo && userInfo.name ? userInfo.name : 'ç®¡ç†å‘˜'}}</text>
      <text class="stats-text">å…±{{totalCount}}æ¡è®°å½•</text>
    </view>

    <!-- è§†å›¾åˆ‡æ¢ -->
    <view class="view-switch">
      <view
        class="switch-button {{viewMode === 'table' ? 'active' : ''}}"
        data-mode="table"
        bindtap="switchView"
      >è¡¨æ ¼è§†å›¾</view>
      <view
        class="switch-button {{viewMode === 'cards' ? 'active' : ''}}"
        data-mode="cards"
        bindtap="switchView"
      >å¡ç‰‡è§†å›¾</view>
    </view>

    <!-- è®¿å®¢åˆ—è¡¨ -->
    <scroll-view
      class="record-list"
      scroll-y
      bindscrolltolower="onReachBottom"
    >
      <view wx:if="{{visitorList.length === 0 && !loading}}" class="empty">
        <image src="../../images/icon/play.png" class="empty-image"></image>
        <text class="empty-text">{{keyword ? 'æš‚æ— æœç´¢ç»“æœ' : 'æš‚æ— è®¿å®¢è®°å½•'}}</text>
      </view>

      <block wx:if="{{viewMode === 'table' && visitorList.length}}">
        <view class="record-table">
          <view class="table-header">
            <view class="cell cell-visitor">è®¿å®¢</view>
            <view class="cell cell-auth">æˆæƒçŠ¶æ€</view>
            <view class="cell cell-count">è®¿é—®æ¬¡æ•°</view>
            <view class="cell cell-time">æœ€è¿‘è®¿é—®</view>
            <view class="cell cell-time">é¦–æ¬¡è®¿é—®</view>
            <view class="cell cell-device">è®¾å¤‡ä¿¡æ¯</view>
            <view class="cell cell-scene">è®¿é—®å…¥å£</view>
            <view class="cell cell-remark">å¤‡æ³¨</view>
            <view class="cell cell-actions">æ“ä½œ</view>
          </view>
          <block wx:for="{{visitorList}}" wx:key="_id">
            <view class="table-row">
              <view class="cell cell-visitor">
                <view class="visitor-cell">
                  <image class="avatar" src="{{item.avatarUrl || defaultAvatar}}" mode="aspectFill"></image>
                  <view class="visitor-meta">
                    <text class="visitor-name">{{item.nickName || 'æœªæˆæƒè®¿å®¢'}}</text>
                    <text class="visit-time">æœ€è¿‘è®¿é—®ï¼š{{formatTime(item.visitTime)}}</text>
                  </view>
                </view>
              </view>
              <view class="cell cell-auth">
                <text class="auth-status {{item.authorized ? 'is-auth' : 'is-unauth'}}">{{item.authorized ? 'å·²æˆæƒ' : 'æœªæˆæƒ'}}</text>
              </view>
              <view class="cell cell-count">{{item.visitCount || 0}}</view>
              <view class="cell cell-time">{{formatTime(item.visitTime)}}</view>
              <view class="cell cell-time">{{formatTime(item.createTime)}}</view>
              <view class="cell cell-device">{{formatDeviceInfo(item.deviceInfo)}}</view>
              <view class="cell cell-scene">{{formatSceneInfo(item.sceneInfo)}}</view>
              <view class="cell cell-remark">{{item.remark || '--'}}</view>
              <view class="cell cell-actions">
                <text class="delete-btn" bindtap="deleteRecord" data-id="{{item._id}}">åˆ é™¤</text>
              </view>
            </view>
          </block>
        </view>
      </block>

      <block wx:elif="{{viewMode === 'cards' && visitorList.length}}">
        <view wx:for="{{visitorList}}" wx:key="_id" class="record-item">
          <view class="item-header">
            <image class="avatar" src="{{item.avatarUrl || defaultAvatar}}" mode="aspectFill"></image>
            <view class="header-main">
              <text class="visitor-name">{{item.nickName || 'æœªæˆæƒè®¿å®¢'}}</text>
              <text class="visit-time">æœ€è¿‘è®¿é—®ï¼š{{formatTime(item.visitTime)}}</text>
            </view>
            <view class="tag-group">
              <view wx:if="{{item.visitCount}}" class="visit-count">ç¬¬{{item.visitCount}}æ¬¡</view>
              <view wx:if="{{item.authorized}}" class="auth-tag">å·²æˆæƒ</view>
            </view>
          </view>

          <view class="item-content">
            <view class="info-row">
              <text class="label">è®¿é—®å…¥å£</text>
              <text class="value">{{formatSceneInfo(item.sceneInfo)}}</text>
            </view>
            <view class="info-row">
              <text class="label">è®¾å¤‡ä¿¡æ¯</text>
              <text class="value">{{formatDeviceInfo(item.deviceInfo)}}</text>
            </view>
            <view class="info-row" wx:if="{{item.clientTime}}">
              <text class="label">å®¢æˆ·ç«¯</text>
              <text class="value">{{formatTime(item.clientTime)}}</text>
            </view>
            <view class="info-row" wx:if="{{item.remark}}">
              <text class="label">å¤‡æ³¨</text>
              <text class="value">{{item.remark}}</text>
            </view>
          </view>

          <view class="item-footer">
            <text class="create-time">é¦–æ¬¡è®¿é—®ï¼š{{formatTime(item.createTime)}}</text>
            <text class="create-time">æœ€è¿‘æ›´æ–°ï¼š{{formatTime(item.updateTime || item.visitTime)}} </text>
            <text class="delete-btn" bindtap="deleteRecord" data-id="{{item._id}}">åˆ é™¤</text>
          </view>
        </view>
      </block>

      <!-- åŠ è½½çŠ¶æ€ -->
      <view wx:if="{{loading}}" class="loading">åŠ è½½ä¸­...</view>
      <view wx:if="{{!hasMore && visitorList.length > 0}}" class="no-more">æ²¡æœ‰æ›´å¤šæ•°æ®äº†</view>
    </scroll-view>
  </view>
</view>
