<wxs src="./index.wxs" module="filter"></wxs>
<view class="container">
  <!-- 非管理员提示 -->
  <view wx:if="{{!isManager}}" class="no-permission">
    <view class="permission-tip">您暂无权限查看访客记录</view>
    <view class="permission-desc">请联系系统管理员</view>
  </view>

  <!-- 管理员界面 -->
  <view wx:else class="manager-view">
    <!-- 搜索栏 -->
    <view class="search-bar">
      <view class="search-input">
        <input
          value="{{keyword}}"
          placeholder="输入访客姓名或访问目的"
          bindinput="onSearchInput"
          bindconfirm="onSearch"
        />
        <text class="search-icon" bindtap="onSearch">🔍</text>
        <text wx:if="{{keyword}}" class="clear-icon" bindtap="onClearSearch">×</text>
      </view>
    </view>

    <!-- 统计信息 -->
    <view class="stats">
      <text class="welcome-text">欢迎，{{userInfo && userInfo.name ? userInfo.name : '管理员'}}</text>
      <text class="stats-text">共{{totalCount}}条记录</text>
    </view>

    <!-- 访客列表 -->
    <scroll-view
      class="record-list"
      scroll-y
      bindscrolltolower="onReachBottom"
    >
      <view wx:if="{{visitorList.length === 0 && !loading}}" class="empty">
        <image src="../../images/icon/play.png" class="empty-image"></image>
        <text class="empty-text">{{keyword ? '暂无搜索结果' : '暂无访客记录'}}</text>
      </view>

      <view wx:for="{{visitorList}}" wx:key="_id" class="record-item">
        <view class="item-header">
          <image class="avatar" src="{{item.avatarUrl || defaultAvatar}}" mode="aspectFill"></image>
          <view class="header-main">
            <text class="visitor-name">{{item.nickName || '未授权访客'}}</text>
            <text class="visit-time">最近访问：{{filter.formatTime(item.visitTime)}}</text>
          </view>
          <view class="tag-group">
            <view wx:if="{{item.visitCount}}" class="visit-count">第{{item.visitCount}}次</view>
            <view wx:if="{{item.authorized}}" class="auth-tag">已授权</view>
          </view>
        </view>

        <view class="item-content">
          <view class="info-row">
            <text class="label">访问入口</text>
            <text class="value">{{filter.formatSceneInfo(item.sceneInfo)}}</text>
          </view>
          <view class="info-row">
            <text class="label">设备信息</text>
            <text class="value">{{filter.formatDeviceInfo(item.deviceInfo)}}</text>
          </view>
          <view class="info-row" wx:if="{{item.clientTime}}">
            <text class="label">客户端</text>
            <text class="value">{{filter.formatTime(item.clientTime)}}</text>
          </view>
          <view class="info-row" wx:if="{{item.remark}}">
            <text class="label">备注</text>
            <text class="value">{{item.remark}}</text>
          </view>
        </view>

        <view class="item-footer">
          <text class="create-time">首次访问：{{filter.formatTime(item.createTime)}}</text>
          <text class="create-time">最近更新：{{filter.formatTime(item.updateTime || item.visitTime)}} </text>
          <text class="delete-btn" bindtap="deleteRecord" data-id="{{item._id}}">删除</text>
        </view>
      </view>

      <!-- 加载状态 -->
      <view wx:if="{{loading}}" class="loading">加载中...</view>
      <view wx:if="{{!hasMore && visitorList.length > 0}}" class="no-more">没有更多数据了</view>
    </scroll-view>
  </view>
</view>
